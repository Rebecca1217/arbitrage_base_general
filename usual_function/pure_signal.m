function [pureSig] = pure_signal(sig, date, tddata, c_stD, c_edD, oriAsset, data1, data2, beta, contM1, contM2, lossRatio, Cost)
%PURE_SIGNAL 
% pure_signal分为三个部分：
% 第一阶段pureSig1，整理出初级的开平仓信号对应行号；
% 第二阶段lossStop，根据止损信息调整信号，并循环直到输入信号不再改变；
% 第三阶段pureSig2，最终删除多余信号，形成用于生成targetPortfolio的终极pure signal.

% 注：需要输入合约代码和时间是因为如果最后一天是平仓日，第二天的开仓价格需要用Wind获取
close1 = data1.close;
close2 = data2.close;

% 第一阶段：
sigLi = pureSig1(sig); % 初步整理开平仓信号，用于输入止损函数调整信号

% 第二阶段：
while size(sigLi, 1) ~= size(lossStop(sigLi, tddata, beta, lossRatio, Cost, oriAsset), 1)
    sigLi = lossStop(sigLi, tddata, beta, lossRatio, Cost, oriAsset);
end
while ~isequal(sigLi, lossStop(sigLi, tddata, beta, lossRatio, Cost, oriAsset)) % 直接比可能面临维数不同的问题
    sigLi = lossStop(sigLi, tddata, beta, lossRatio, Cost, oriAsset);
end

% 第三阶段：
sigLi = pureSig2(sigLi, date, oriAsset, c_stD, c_edD);


% 最后，计算手数，调整格式
Ratio = beta;% 用于计算手数
% 在上述漫雪信号的基础上调整成输入targetPortfolio格式：
tdList = zeros(length(sig),8);
num = size(sigLi,1);
asset = oriAsset;

if num == 0
    pureSig = zeros(size(sig, 1), 3);
    pureSig = [date pureSig];
    return
end



for i = 1:num %逐个信号计算
    opL = sigLi(i,2); %开仓信号所在行                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    clL = sigLi(i,3); %平仓信号所在行
    sgn1 = sigLi(i,1); %开仓方向-第一个品种的方向
    sgn2 = -sigLi(i,1); %开仓方向-第二个品种的方向
    sgn = sigLi(i,1);
    if clL-opL>1 %不是当根开下根平的情况
        tdList(opL: (clL - 1),1) = sgn;  % 开仓信号当天到平仓信号前一天
%         tdList(opL+1,2) = 2-sgn; %多空开
%         tdList(clL,2) = 3-sgn; %多空平
        % 开仓手数每天再平衡
        chgH1 = 0;
        chgH2 = 0;
        for d = opL:clL-1 
            % 计算开仓手数
            hands = calOpenHands([close1(d) close2(d)],Ratio(d),asset,contM1,contM2); %用前一天的收盘价去计算当天的手数     
            if d==opL %开仓时的手数
                h1 = hands(1);
                h2 = hands(2);
            end
            if d>opL %相比于开仓时手数的变化
                chgH1 = hands(1)-h1;
                chgH2 = hands(2)-h2;
            end
            if abs(chgH1)>2 || abs(chgH2)>2 %两个品种中任意一个的持仓手数变化超过2手，则两个品种一起调仓
                tdList(d,5) = hands(1);
                tdList(d,6) = hands(2);
                h1 = hands(1);
                h2 = hands(2);
            else
                tdList(d,5) = h1;
                tdList(d,6) = h2;
            end
        end
    end
    if clL-opL==1 %当根开下根平
        tdList(opL,1) = sgn;
        hands = calOpenHands([close1(opL) close2(opL)], Ratio(opL), asset, contM1, contM2); %用前一天的收盘价去计算当天的手数
        tdList(opL+1,5) = hands(1);
        tdList(opL+1,6) = hands(2);
       
    end
    
%     % 市值更新
%     asset = tdList(clL,8);
%     % 市值填充
%     if i<num
%         tdList(clL+1:sigLi(i+1,2),8) = asset;
%     else
%         tdList(clL:end,8) = asset;
%     end
        
end

pureSig = tdList(:, [1 5:6]);
pureSig(:, 2) = pureSig(:, 1) .* pureSig(:, 2);
pureSig(:, 3) = -pureSig(:, 1) .* pureSig(:, 3);
pureSig = [date pureSig];
pureSig = pureSig(pureSig(:, 1) >= c_stD & pureSig(:, 1) <= c_edD, :);

end

